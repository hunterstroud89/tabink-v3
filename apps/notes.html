<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Notes</title>
  <link rel="stylesheet" href="../assets/style.css" />
  <script src="../lib/sql-wasm.js"></script>
  <script src="../functions/db.js"></script>
  <script src="../functions/config.js"></script>
  <script src="../functions/settings.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    .topbar {
      margin: 0;
      flex-shrink: 0;
    }
    
    #noteTextarea {
      flex: 1;
      width: 100%;
      border: none;
      outline: none;
      padding: var(--space-md);
      font-family: inherit;
      font-size: 16px;
      line-height: 1.6;
      background: var(--bg-primary);
      color: var(--text-primary);
      resize: none;
      box-sizing: border-box;
    }
    
    #noteTextarea::placeholder {
      color: var(--text-secondary);
    }
  </style>
  
  <script>
    // Load SVG icon sprite
    fetch('../assets/icons/icons.svg')
      .then(response => response.text())
      .then(data => {
        const div = document.createElement('div');
        div.style.display = 'none';
        div.innerHTML = data;
        document.body.insertBefore(div, document.body.firstChild);
      })
      .catch(err => console.error('Failed to load icons:', err));
  </script>
</head>
<body>
  <div class="topbar">
    <div class="topbar-title" style="text-align: left;">
      <a href="../index.html" style="color: inherit; text-decoration: none; opacity: 0.6;">Home</a>
      <span style="opacity: 0.4; margin: 0 var(--space-xs);">/</span>
      <span onclick="openNotesMenu()" style="cursor: pointer;">Notes ▼</span>
    </div>
    <div class="topbar-actions">
      <button onclick="createNewNote()">+ New</button>
    </div>
  </div>
  <textarea id="noteTextarea" placeholder="Start typing..."></textarea>
  
  <script>
    const textarea = document.getElementById('noteTextarea');
    let currentNoteId = null;
    let saveTimeout = null;
    
    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      await db.init();
      await loadAllNotes();
    });
    
    function goHome() {
      window.location.href = '../index.html';
    }
    
    async function loadAllNotes() {
      const notes = await db.getNotes();
      
      // Create first note if none exist
      if (notes.length === 0) {
        const id = Date.now().toString();
        await db.saveNote(id, 'First Note', '');
      }
      
      // Check if we should open a specific note
      const requestedNoteId = localStorage.getItem('notes:openNote');
      localStorage.removeItem('notes:openNote');
      
      if (requestedNoteId) {
        const note = await db.getNote(requestedNoteId);
        if (note) {
          loadNote(requestedNoteId);
          return;
        }
      }
      
      // Load most recent note
      const allNotes = await db.getNotes();
      if (allNotes.length > 0) {
        loadNote(allNotes[0].id);
      }
    }
    
    async function loadNote(noteId) {
      // Save current note before switching
      if (currentNoteId) {
        await saveCurrentNote();
      }
      
      currentNoteId = noteId;
      const note = await db.getNote(noteId);
      
      if (note) {
        textarea.value = note.content || '';
      } else {
        textarea.value = '';
      }
    }
    
    async function saveCurrentNote() {
      if (!currentNoteId) return;
      
      const content = textarea.value;
      const title = content.split('\n')[0].trim() || 'Untitled';
      
      await db.saveNote(currentNoteId, title, content);
    }
    
    async function createNewNote() {
      const id = Date.now().toString();
      await db.saveNote(id, 'New Note', '');
      await loadNote(id);
      textarea.focus();
      hidePopup();
    }
    
    async function openNotesMenu() {
      const notes = await db.getNotes();
      
      let popupHTML = `
        <div class="popup active">
          <div class="popup-header">
            <h3 class="popup-title">
              <svg class="icon icon-lg" style="vertical-align: middle; margin-right: var(--space-xs);">
                <use href="#icon-folder"></use>
              </svg>
              All Notes
            </h3>
            <button class="close-btn" onclick="hidePopup()"></button>
          </div>
          <div class="popup-content">`;
      
      notes.forEach((note, index) => {
        const isActive = note.id === currentNoteId;
        popupHTML += `
          <div class="popup-item${isActive ? ' active' : ''}" data-number="${index + 1}">
            <div style="flex:1;cursor:pointer" onclick="loadNoteFromMenu('${note.id}')">
              <strong>${escapeHtml(note.title)}</strong>
            </div>
            <button onclick="deleteNoteFromMenu('${note.id}', event)" style="padding: 2px 8px; font-size: 1.2em; line-height: 1; border: 2px solid var(--border-color); background: var(--bg-inset); border-radius: 3px; cursor: pointer;">×</button>
          </div>`;
      });
      
      popupHTML += `
          </div>
          <div class="popup-footer">
            <span>${notes.length} notes</span>
          </div>
        </div>
        <div class="popup-overlay active" onclick="hidePopup()"></div>`;
      
      document.body.insertAdjacentHTML('beforeend', popupHTML);
    }
    
    function hidePopup() {
      const popup = document.querySelector('.popup');
      const overlay = document.querySelector('.popup-overlay');
      if (popup) popup.remove();
      if (overlay) overlay.remove();
    }
    
    async function loadNoteFromMenu(noteId) {
      await loadNote(noteId);
      hidePopup();
    }
    
    async function deleteNoteFromMenu(noteId, event) {
      event.stopPropagation();
      
      const notes = await db.getNotes();
      if (notes.length <= 1) {
        alert("Can't delete the last note!");
        return;
      }
      
      if (confirm('Delete this note?')) {
        await db.deleteNote(noteId);
        
        // If we deleted the current note, load another one
        if (noteId === currentNoteId) {
          const remainingNotes = await db.getNotes();
          if (remainingNotes.length > 0) {
            currentNoteId = null; // Reset so loadNote doesn't save
            await loadNote(remainingNotes[0].id);
          }
        }
        
        hidePopup();
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Auto-save on input
    textarea.addEventListener('input', () => {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveCurrentNote, 800);
    });
    
    // Save before leaving
    window.addEventListener('beforeunload', async () => {
      clearTimeout(saveTimeout);
      if (currentNoteId) {
        await saveCurrentNote();
      }
    });
  </script>
</body>
</html>
